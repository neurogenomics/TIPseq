---
title: "EpiCompare"
date: "<h4>Vignette updated: <i>`r format( Sys.Date(), '%b-%d-%Y')`</i></h4>"
output:
  BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{templateR} 
    %\usepackage[utf8]{inputenc}
    %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, root.dir=here::here())
knitr::opts_knit$set(echo = TRUE, root.dir=here::here())

#### CRAN ####
pkgs <- c("dplyr")
for(p in pkgs){
  if(!require(p, character.only = TRUE)) install.packages(p)
} 
#### GitHub ####
if(!require("EpiCompare")) remotes::install_github("neurogenomics/EpiCompare")

source(here::here("code/utils.R"))
root <- "/Volumes/bms20/projects/neurogenomics-lab/live/Data/tip_seq"
```

# Import data 

Import the called peak files produced by the [nf-core/cutanrun](https://nf-co.re/cutandrun) pipeline.

```{r}
peakfiles <- EpiCompare::gather_files(dir = file.path(root,"processed_data"),
                                      type = "peaks.stringent",
                                      nfcore_cutandrun=TRUE,
                                      workers = 10)

picardfiles <- EpiCompare::gather_files(dir = file.path(root,"processed_data"),
                                        type = "picard",
                                        nfcore_cutandrun=TRUE,
                                        workers = 10)
```

### Translate sample names

```{r}

batches <- data.frame(batch=list.files("/Volumes/bms20/projects/neurogenomics-lab/live/Data/tip_seq/raw_data/H3K27ac_K562_cells")) %>%
  tidyr::separate(col = "batch",into = c("V1","phase","day","month","year"),
                  remove = FALSE, sep = "_") %>%
  dplyr::mutate(date = strptime(paste(day,month,year,sep="/"),format="%d/%b/%Y", tz = "UTC"))


sample_meta <- readxl::read_excel("reports/Bulk TIP-seq samples_V2.xlsx",
                                  skip = 6) %>%
  dplyr::mutate(name = gsub(" +","",paste(`histone mark`,
                                          `antibody company`,
                                          # `antibody catalog`,
                                          # `antibody concentration`,
                                          # `cell line`,
                                          sep="_"))
                )  %>%
  data.frame() %>%  
  dplyr::left_join(batches, by="date")
sample_dict <- stats::setNames(sample_meta$name, 
                               sample_meta$batch)


#### Translate names ####
peakfiles <- rename_files(files = peakfiles, 
                           sample_dict = sample_dict, max_char = 40)
picardfiles <- rename_files(files = picardfiles, 
                             sample_dict = sample_dict, max_char = 40)
```

### Get ENCODE data

Import the full genome-wide ENCODE data since 
(`encode_H3K27ac` only includes chromosome 1).
- [H3K27ac_K562_ENCODE_ENCFF044JNJ](https://www.encodeproject.org/files/ENCFF044JNJ/) 

Use the function `EpiCompare::import_narrowPeak` 
instead of the usual `rtracklayer::import` because the latter is
unable to parse this particular set of files.

```{r} 
#### H3K27ac ####  
encode_ac <- rtracklayer::import("https://www.encodeproject.org/files/ENCFF044JNJ/@@download/ENCFF044JNJ.bed.gz", format = "narrowPeak")

# names(encode1)[1] <- "H3K27ac_K562_ENCODE_ENCFF044JNJ"

#### H3K27me3 ####
encode_me3 <- rtracklayer::import( "https://www.encodeproject.org/files/ENCFF322IFF/@@download/ENCFF322IFF.bed.gz", 
                                  format = "narrowPeak")

ref_list <- list("encode_ac"=encode_ac,
                 "encode_me3"=encode_me3)
```


```{r}

data("hg38_blacklist") # example blacklist 

out_list <- lapply(names(ref_list), function(nm){
  message("\n","======>> ",nm," <<======","\n")
  save_dir <- here::here("reports",nm)
  dir.create(save_dir, showWarnings = FALSE, recursive = TRUE)
  EpiCompare::EpiCompare(peakfiles = peakfiles, 
                         picard_files = picardfiles,
                         blacklist = hg38_blacklist,
                         genome_build = list(peakfiles="hg38",
                                             reference="hg38",
                                             blacklist="hg38"),
                         genome_build_output = "hg38",
                         reference = ref_list[nm],
                         upset_plot = TRUE,
                         stat_plot = TRUE,
                         chromHMM_plot = TRUE,
                         chromHMM_annotation = "K562",
                         chipseeker_plot = TRUE,
                         enrichment_plot = TRUE,
                         tss_plot = TRUE,
                         save_output = TRUE, 
                         output_dir = save_dir)
})

```

 
# Session Info 

<details> 

```{r Session Info}
utils::sessionInfo()
```

</details>  

<br>
